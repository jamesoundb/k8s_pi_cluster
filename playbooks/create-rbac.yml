---
# Create RBAC permissions for kubeadmin
- name: Setup RBAC permissions for cluster admin
  hosts: k8s_master_init
  become: true
  tasks:
    - name: Check if admin.conf exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_stat
      
    - name: Display admin.conf status
      debug:
        msg: "admin.conf exists: {{ admin_conf_stat.stat.exists }}"
        
    - name: Fail if admin.conf is missing
      fail:
        msg: "Error: /etc/kubernetes/admin.conf is missing. The Kubernetes API server may not have initialized properly."
      when: not admin_conf_stat.stat.exists

    - name: Create kubernetes-admin RBAC configuration
      copy:
        dest: /tmp/kubernetes-admin-rbac.yaml
        content: |
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: kubernetes-admin
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: User
            name: kubernetes-admin
        mode: '0644'

    - name: Apply kubernetes-admin RBAC configuration
      shell: kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f /tmp/kubernetes-admin-rbac.yaml
      register: rbac_result
      
    - name: Display RBAC application result
      debug:
        var: rbac_result.stdout_lines
