---
# Monitoring playbook for Kubernetes control plane health checks

- name: Check Kubernetes control plane health
  hosts: k8s_master_init
  become: true
  become_user: "{{ ansible_user }}"
  tasks:
    - name: Check nodes status
      shell: kubectl get nodes -o wide
      register: nodes_status
      changed_when: false

    - name: Display nodes status
      debug:
        var: nodes_status.stdout_lines

    - name: Check kube-system pods status
      shell: kubectl get pods -n kube-system -o wide
      register: kube_system_status
      changed_when: false

    - name: Display kube-system pods status
      debug:
        var: kube_system_status.stdout_lines

    - name: Check etcd health
      shell: kubectl -n kube-system exec -it etcd-{{ inventory_hostname }} -- etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key --endpoints=https://127.0.0.1:2379 endpoint health
      register: etcd_health
      changed_when: false
      ignore_errors: true

    - name: Display etcd health
      debug:
        var: etcd_health.stdout_lines
      when: etcd_health.stdout_lines is defined

    - name: Check etcd member list
      shell: kubectl -n kube-system exec -it etcd-{{ inventory_hostname }} -- etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key --endpoints=https://127.0.0.1:2379 member list -w table
      register: etcd_members
      changed_when: false
      ignore_errors: true

    - name: Display etcd member list
      debug:
        var: etcd_members.stdout_lines
      when: etcd_members.stdout_lines is defined

    - name: Check API server health
      uri:
        url: https://{{ control_plane_endpoint }}:{{ control_plane_endpoint_port | default('6443') }}/healthz
        validate_certs: no
        return_content: true
      register: api_health
      ignore_errors: true

    - name: Display API server health
      debug:
        var: api_health.content

    - name: Check component statuses
      shell: kubectl get componentstatuses
      register: component_statuses
      changed_when: false

    - name: Display component statuses
      debug:
        var: component_statuses.stdout_lines

- name: Check HA status
  hosts: k8s_master
  become: true
  tasks:
    - name: Check HAProxy status
      command: systemctl status haproxy
      register: haproxy_status
      changed_when: false
      ignore_errors: true

    - name: Display HAProxy status
      debug:
        var: haproxy_status.stdout_lines
      when: haproxy_status.stdout_lines is defined

    - name: Check Keepalived status
      command: systemctl status keepalived
      register: keepalived_status
      changed_when: false
      ignore_errors: true

    - name: Display Keepalived status
      debug:
        var: keepalived_status.stdout_lines
      when: keepalived_status.stdout_lines is defined

    - name: Check which node has the VIP
      shell: ip addr | grep {{ control_plane_endpoint }} || echo "VIP not on this node"
      register: vip_check
      changed_when: false

    - name: Display VIP status
      debug:
        var: vip_check.stdout_lines