---
# Port configuration playbook - Ensures consistent port configuration across the cluster
# This playbook should run after cluster initialization but before CNI setup

- name: Ensure consistent port configuration in Kubernetes components
  hosts: k8s_master_init
  become: true
  vars:
    api_endpoint_address: "{{ ansible_host }}"
    api_server_port: 6444      # The port where kube-apiserver listens
    lb_port: 6443              # The port where HAProxy listens (standard API server port)
    control_plane_vip: "192.168.1.100"  # VIP address

  tasks:
    # First check the API server configuration
    - name: Verify API server is configured correctly
      shell: "grep -o 'secure-port=6444' /etc/kubernetes/manifests/kube-apiserver.yaml || echo 'not-configured'"
      register: api_port_check
      ignore_errors: true
      
    - name: Analyze API server port configuration
      debug:
        msg: "API server port configuration: {{ 'Correct (6444)' if 'secure-port=6444' in api_port_check.stdout else 'Incorrect (not set to 6444)' }}"

    # Check if kube-apiserver.yaml exists, if not restore from backup
    - name: Check if kube-apiserver manifest exists
      stat:
        path: /etc/kubernetes/manifests/kube-apiserver.yaml
      register: api_manifest_stat
    
    - name: Check if kube-apiserver backup exists
      stat:
        path: /etc/kubernetes/manifests/kube-apiserver.yaml.bak
      register: api_backup_stat
      when: not api_manifest_stat.stat.exists
    
    - name: Restore kube-apiserver manifest from backup if needed
      copy:
        src: /etc/kubernetes/manifests/kube-apiserver.yaml.bak
        dest: /etc/kubernetes/manifests/kube-apiserver.yaml
        remote_src: yes
        mode: '0644'
      when: not api_manifest_stat.stat.exists and api_backup_stat.stat.exists
      register: restored_api_manifest
    
    - name: Wait for API server to restart after restoring manifest
      pause:
        seconds: 30
      when: restored_api_manifest is changed

    # Update API server manifest if needed using in-place modifications
    - name: Backup kube-apiserver manifest before modifications
      copy:
        src: /etc/kubernetes/manifests/kube-apiserver.yaml
        dest: /etc/kubernetes/manifests/kube-apiserver.yaml.bak
        remote_src: yes
        mode: '0644'
      when: api_port_check.stdout == 'not-configured'
      register: api_backup
      
    - name: Update API server secure port in manifest (in-place)
      replace:
        path: /etc/kubernetes/manifests/kube-apiserver.yaml
        regexp: '--secure-port=6443'
        replace: '--secure-port=6444'
      when: api_port_check.stdout == 'not-configured'
      register: api_port_update
      
    - name: Update all health check probe ports in API server manifest (in-place)
      replace:
        path: /etc/kubernetes/manifests/kube-apiserver.yaml
        regexp: '([ ]{8}port: )6443(\n[ ]{8}scheme: HTTPS)'
        replace: '\16444\2'
      when: api_port_check.stdout == 'not-configured'
      register: api_probe_update
      
    - name: Verify kube-apiserver manifest still exists after updates
      stat:
        path: /etc/kubernetes/manifests/kube-apiserver.yaml
      register: api_manifest_after_update
      
    - name: Restore from backup if manifest was lost during updates
      copy:
        src: /etc/kubernetes/manifests/kube-apiserver.yaml.bak
        dest: /etc/kubernetes/manifests/kube-apiserver.yaml
        remote_src: yes
        mode: '0644'
      when: not api_manifest_after_update.stat.exists and api_backup is changed
      notify: Restart kubelet

    # Verify HAProxy configuration
    - name: Check HAProxy configuration
      shell: "grep -A 5 'backend k8s-api-backend' /etc/haproxy/haproxy.cfg | grep -o '{{ api_endpoint_address }}:6444' || echo 'not-configured'"
      register: haproxy_check
      ignore_errors: true
      
    - name: Analyze HAProxy backend configuration
      debug:
        msg: "HAProxy backend configuration: {{ 'Correct (points to 6444)' if api_endpoint_address + ':6444' in haproxy_check.stdout else 'Incorrect (not pointing to port 6444)' }}"

    # Update HAProxy if needed
    - name: Reconfigure HAProxy if needed
      template:
        src: ../roles/kube_apiserver/templates/haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        owner: root
        group: root
        mode: '0644'
      vars:
        control_plane_endpoint: "{{ control_plane_vip }}"
        control_plane_endpoint_port: "{{ lb_port }}"
      when: api_endpoint_address + ':6444' not in haproxy_check.stdout
      register: haproxy_updated

    - name: Restart HAProxy if configuration was updated
      systemd:
        name: haproxy
        state: restarted
      when: haproxy_updated is changed

    # Now check and update all kubeconfig files
    - name: Gather all kubeconfig files
      find:
        paths: /etc/kubernetes
        patterns: "*.conf"
      register: kubeconfig_files

    - name: Check each kubeconfig file
      shell: "grep -o 'server: https://.*:6443' {{ item.path }} || echo 'correctly-configured'"
      register: kubeconfig_checks
      with_items: "{{ kubeconfig_files.files }}"
      loop_control:
        label: "{{ item.path }}"
      ignore_errors: true
      
    - name: Update kubeconfig files that use incorrect port
      replace:
        path: "{{ item.item.path }}"
        regexp: 'server: https://.*:6443'
        replace: 'server: https://{{ api_endpoint_address }}:{{ api_server_port }}'
      with_items: "{{ kubeconfig_checks.results }}"
      when: item.stdout != 'correctly-configured'
      loop_control:
        label: "{{ item.item.path }}"
      register: kubeconfig_updates

    # Also check and update the user's kubeconfig
    - name: Check user kubeconfig
      stat:
        path: "/home/{{ ansible_user }}/.kube/config"
      register: user_kubeconfig
    
    - name: Update user kubeconfig if it exists
      replace:
        path: "/home/{{ ansible_user }}/.kube/config"
        regexp: 'server: https://.*:6443'
        replace: 'server: https://{{ api_endpoint_address }}:{{ api_server_port }}'
      when: user_kubeconfig.stat.exists
      register: user_kubeconfig_updated

    # Restart kubelet if any kubeconfig files were updated
    - name: Restart kubelet to pick up configuration changes
      systemd:
        name: kubelet
        state: restarted
      when: kubeconfig_updates is changed or user_kubeconfig_updated is changed

    # Final validation - see if kubelet can connect to API server
    - name: Wait for kubelet to connect to API server
      shell: "journalctl -u kubelet --no-pager -n 50 | grep -o 'Successfully registered node' || echo 'not-registered'"
      register: kubelet_registration
      retries: 5
      delay: 10
      until: "'Successfully registered node' in kubelet_registration.stdout"
      ignore_errors: true
      
    - name: Display kubelet registration status
      debug:
        msg: "Kubelet registration status: {{ 'Success' if 'Successfully registered node' in kubelet_registration.stdout else 'Failed - kubelet cannot register with API server' }}"

    # List active API server processes and ports
    - name: Check running API server processes
      shell: "ps aux | grep kube-apiserver | grep -v grep || echo 'No API server processes found'"
      register: api_processes
      
    - name: Display API server processes
      debug:
        var: api_processes.stdout_lines
        
    - name: Check listening ports
      shell: "ss -tlnp | grep -E '6443|6444' || echo 'No services on API server ports'"
      register: api_ports
      
    - name: Display API server ports
      debug:
        var: api_ports.stdout_lines

    # Document the architecture
    - name: Create port configuration documentation
      copy:
        dest: "/home/{{ ansible_user }}/kubernetes-port-architecture.md"
        content: |
          # Kubernetes Port Configuration
          
          ## Current Configuration
          
          - **API Server**: Listening on port {{ api_server_port }} (internal)
          - **HAProxy**: Forwarding from port {{ lb_port }} (external) to port {{ api_server_port }} (internal)
          - **Virtual IP**: {{ control_plane_vip }} (for high availability)
          
          ## Connection Flow
          
          1. Kubelet and other components connect to API server directly on port {{ api_server_port }}
          2. External tools (kubectl from outside) connect to the VIP ({{ control_plane_vip }}) on port {{ lb_port }}
          3. HAProxy forwards the external connections to the API server on port {{ api_server_port }}
          
          ## Troubleshooting
          
          If connection issues occur, verify that:
          
          1. API server is configured with `--secure-port={{ api_server_port }}` in the manifest
          2. All kubeconfig files have the correct server URL with port {{ api_server_port }}
          3. HAProxy is forwarding from {{ lb_port }} to {{ api_server_port }}
          4. Kubelet is properly configured to connect to port {{ api_server_port }}
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
