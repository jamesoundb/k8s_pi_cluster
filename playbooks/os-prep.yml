---
# OS Preparation Playbook - Extracted from k8s-setup.yml
# This handles all OS-level preparations needed before Kubernetes components can be installed

- name: Prepare Operating System for Kubernetes
  hosts: k8s_nodes
  become: true
  vars:
    k8s_version: "1.29.0"
    k8s_username: "{{ ansible_user }}"
  
  tasks:
    - name: Wait for apt locks to be released
      shell: |
        while lsof /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || lsof /var/lib/apt/lists/lock >/dev/null 2>&1 || lsof /var/cache/apt/archives/lock >/dev/null 2>&1 || lsof /var/lib/dpkg/lock >/dev/null 2>&1; do
          echo "Waiting for apt lock to be released..."
          sleep 5
        done
      changed_when: false
      
    - name: Fix all corrupted dpkg files
      shell: |
        rm -rf /var/lib/dpkg/updates/*
        touch /var/lib/dpkg/status
      changed_when: true
    
    - name: Fix dpkg database
      shell: |
        mkdir -p /var/lib/dpkg/info
        mkdir -p /var/lib/dpkg/updates
        dpkg --clear-avail
        apt-get update --fix-missing
        apt-get install -f -y
        apt-get clean
      changed_when: true
      ignore_errors: true
    
    - name: Fix interrupted dpkg (if any)
      shell: dpkg --configure -a
      ignore_errors: true
      changed_when: false
      
    - name: Remove old Kubernetes repository (if exists)
      file:
        path: /etc/apt/sources.list.d/kubernetes.list
        state: absent
      
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - python3-pip
          - python3-venv
          - python3-dev
          - libffi-dev
          - libssl-dev
          - git
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - sshpass # For copying kubeconfig between nodes
          - htop
          - iotop
          - iftop
          - atop
        state: present
    
    - name: Create Kubernetes apt keyring directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
    
    - name: Add Kubernetes apt key
      shell: curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    
    - name: Add Kubernetes apt repository
      shell: echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
      args:
        creates: /etc/apt/sources.list.d/kubernetes.list
    
    - name: Update apt cache after adding Kubernetes repo
      apt:
        update_cache: yes
    
    - name: Install Kubernetes components
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
    
    - name: Hold Kubernetes packages
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl
    
    - name: Load kernel modules
      shell: |
        modprobe overlay
        modprobe br_netfilter
    
    - name: Create kernel modules config for kubernetes
      copy:
        dest: /etc/modules-load.d/kubernetes.conf
        content: |
          overlay
          br_netfilter
        mode: '0644'
    
    - name: Create sysctl config for kubernetes
      copy:
        dest: /etc/sysctl.d/kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.ipv4.ip_forward = 1
        mode: '0644'
    
    - name: Apply sysctl parameters
      shell: sysctl --system
    
    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/swap/d' /etc/fstab
      
    - name: Add {{ k8s_username }} to docker group
      user:
        name: "{{ k8s_username }}"
        groups: docker
        append: yes
      ignore_errors: true
        
    # Lightweight server optimization tasks
    - name: Remove unnecessary packages
      apt:
        name:
          - snapd
          - landscape-common
          - plymouth
          - apport
          - whoopsie
          - unattended-upgrades
          - popularity-contest
        state: absent
        purge: yes
        autoremove: yes
      ignore_errors: true
      
    - name: Disable unnecessary services
      systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      with_items:
        - apt-daily.timer
        - apt-daily-upgrade.timer
        - fstrim.timer
        - motd-news.timer
        - man-db.timer
        - logrotate.timer
      ignore_errors: true
    
    - name: Clean up journal logs
      command: journalctl --vacuum-time=1d
      changed_when: true
    
    - name: Set systemd journal max size
      copy:
        dest: /etc/systemd/journald.conf
        content: |
          [Journal]
          SystemMaxUse=100M
          SystemMaxFileSize=20M
          MaxRetentionSec=1day
    
    - name: Reduce swappiness
      sysctl:
        name: vm.swappiness
        value: '1'
        state: present
    
    # Raspberry Pi specific performance optimizations
    - name: Create GPU memory split configuration for Pi
      lineinfile:
        path: /boot/firmware/config.txt
        line: "{{ item }}"
        create: yes
      with_items:
        - "# Limit GPU memory to provide more RAM to the system"
        - "gpu_mem=16"
      when: "'arm' in ansible_architecture"
      ignore_errors: true
    
    - name: Optimize kernel parameters for container workloads
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-kubernetes-performance.conf
      with_items:
        - { name: 'kernel.panic', value: '10' }
        - { name: 'kernel.panic_on_oops', value: '1' }
        - { name: 'vm.overcommit_memory', value: '1' }
        - { name: 'vm.panic_on_oom', value: '0' }
        - { name: 'net.ipv4.tcp_slow_start_after_idle', value: '0' }
        - { name: 'net.core.somaxconn', value: '32768' }
        - { name: 'net.ipv4.tcp_max_syn_backlog', value: '8096' }
        - { name: 'fs.inotify.max_user_watches', value: '524288' }
        - { name: 'fs.file-max', value: '1000000' }
