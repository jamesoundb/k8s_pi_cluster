---
# Main Kubernetes Cluster Orchestration Playbook
# This playbook replaces the functionality of deploy.sh
# Run with: ansible-playbook -i inventory.yml playbooks/deploy-cluster.yml

- name: Pre-flight checks
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Ensure Ansible is installed
      fail:
        msg: "Ansible is not installed. Please install Ansible before proceeding."
      when: ansible_pkg_mgr is not defined
      
    - name: Check SSH key exists
      stat:
        path: "~/.ssh/id_rsa"
      register: ssh_key
      
    - name: Generate SSH key if it does not exist
      shell: ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
      when: not ssh_key.stat.exists
      
    - name: Check connection to all nodes
      command: ansible -i {{ inventory_file | default('inventory.yml') }} all -m ping
      register: ping_result
      ignore_errors: true
      changed_when: false
      
    - name: Fail if connection check fails
      fail:
        msg: "Failed to connect to some nodes. Please verify your inventory and SSH setup."
      when: ping_result.rc != 0

# Include the main cluster deployment playbook
- import_playbook: ../k8s-cluster-deploy.yml

# Deploy core infrastructure after main cluster is ready
- name: Deploy Core Infrastructure
  import_playbook: post-install.yml

- name: Display Cluster Information
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Get control plane endpoint from group vars
      shell: "grep -w control_plane_endpoint ../group_vars/all.yml | cut -d: -f2 | tr -d ' '"
      register: cp_endpoint
      changed_when: false

    - name: Get primary control plane node from inventory
      shell: "grep -A1 k8s_master_init ../inventory.yml | grep k8s-node | cut -d':' -f1 | tr -d ' '"
      register: primary_cp_node
      changed_when: false
      
    - name: Display cluster information
      debug:
        msg:
          - "=== Cluster Information ==="
          - "Control plane API endpoint: {{ cp_endpoint.stdout }}:6443"
          - "Primary control plane node: {{ primary_cp_node.stdout }}"
          - "To connect to the cluster:"
          - "  export KUBECONFIG=~/.kube/config"
          - "  kubectl get nodes"
