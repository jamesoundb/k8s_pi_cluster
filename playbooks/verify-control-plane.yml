---
# Verify that all control plane nodes are operational
- name: Verify Kubernetes control plane nodes
  hosts: k8s_master_init
  become: true
  gather_facts: true
  tasks:
    - name: Check API server status on all control plane nodes
      shell: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get pods -n kube-system -l component=kube-apiserver -o wide
      register: apiserver_status
      changed_when: false

    - name: Display API server status
      debug:
        msg: "{{ apiserver_status.stdout_lines }}"

    - name: Check etcd status on all control plane nodes
      shell: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get pods -n kube-system -l component=etcd -o wide
      register: etcd_status
      changed_when: false

    - name: Display etcd status
      debug:
        msg: "{{ etcd_status.stdout_lines }}"

    - name: Verify all nodes are Ready
      shell: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes
      register: node_status
      changed_when: false

    - name: Display node status
      debug:
        msg: "{{ node_status.stdout_lines }}"

    - name: Check control plane component health
      shell: >
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get componentstatuses
      register: component_status
      changed_when: false
      ignore_errors: yes # This command is deprecated in newer versions

    - name: Display component health status
      debug:
        msg: "{{ component_status.stdout_lines }}"
      when: component_status is success

    - name: Check Kubernetes API server endpoints
      shell: >
        curl -k https://{{ item }}:6443/healthz || echo "API server not responding"
      register: apiserver_health
      changed_when: false
      with_items:
        - "{{ hostvars[groups['k8s_master'][0]].ansible_host }}"
        - "{{ hostvars[groups['k8s_master'][1]].ansible_host }}"
        - "{{ hostvars[groups['k8s_master'][2]].ansible_host }}"
      ignore_errors: yes

    - name: Display API server health status
      debug:
        msg: "Node {{ item.item }} health: {{ item.stdout }}"
      with_items: "{{ apiserver_health.results }}"

    - name: Verify VIP is working
      shell: >
        curl -k https://{{ control_plane_endpoint }}:{{ control_plane_endpoint_port | default('6443') }}/healthz || echo "VIP not responding"
      register: vip_health
      changed_when: false
      ignore_errors: yes

    - name: Display VIP health status
      debug:
        msg: "VIP health: {{ vip_health.stdout }}"

    - name: Fail if any API server is not healthy
      fail:
        msg: "One or more API servers are not healthy"
      when: "'API server not responding' in apiserver_health.results | map(attribute='stdout') | join(' ')"
