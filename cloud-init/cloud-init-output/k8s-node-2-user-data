#cloud-config

# Minimal Ubuntu 24.04 LTS Cloud-Init Configuration for Kubernetes Node: k8s-node-2
# Generated for user: k8s_81 
# Simplified for fast boot and reliable provisioning

# System Information
hostname: k8s-node-2
prefer_fqdn_over_hostname: false
manage_etc_hosts: true

# User Configuration
users:
  - name: k8s_81
    groups: [adm, sudo, netdev]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC9eiOsfazo+EtrfPrSLbiRUxCMq1ihs11AUGczdT1DNJZp52qhXEzOmGMW6KMy3xvOmfMDu1C/vwttieQ/xVKEmXCIjVJ7A1cvNDWYWwH5R+Q8SUFVy7M7WPoMXZ4STK9OQOCDd696+k/eOZg0H0vZoECpy/ku4eNVbEdBXWltGhC245IU0+eGbrtLnMD4Exv/eCXZEPMEwBsyNTg+DFbc1WYHu9cYQarC9SCStWouUoGdxI2SEZ6tabijnmsqVDZmWGIutYCGgyizl+wE4p/VJHKNpcQsoguLTgXyIaJe5Ab7bYpIrSPritGBTKBW1v5Dsm2sgV8Uqg5afDovUOH2tWN2uQYmuE+TBIYt5CZrEdPItewNyapFSVQxERH71mDwe5dojS4Ps0pcFG6V8y5xp6PP7uVtxMZiGo+zPduG8RFKUqjw52rAFZG6jfuziK6Ry9UislzIDLFy+O2VA9MUV7XI6u06CoVsyZunSzwH+stH/vG7B/Y+dPkBBvnOYMvjXAGsbVYDLVv+uLkvs6tRCS707jVKFK49CM4EU9M9Xpq7lWTbPJHGAnuoUzc5OdgICAq3NB4qXBE2JX+0ag5FqvSfyIsUbotPTUjvDFPDo3SOpkw4nY3AyrHEbbocSURc5e6W/cd6BfH8QsrU682Nvt6cMxJZU+lEQdR6MhZwkQ== k8s_pi_cluster
    lock_passwd: true

# Package Management - Essential only
package_update: true
package_upgrade: false  # Skip upgrade for speed
packages:
  # Absolute essentials only
  - curl
  - wget
  - vim
  - net-tools
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg

# System Configuration
timezone: UTC
locale: en_US.UTF-8

# Essential Kubernetes preparation only
write_files:
  - path: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
    permissions: '0644'
    owner: root:root

  - path: /etc/sysctl.d/k8s.conf  
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
    permissions: '0644'
    owner: root:root

# SSH Configuration
ssh:
  emit_keys_to_console: false
  ssh_deletekeys: true
  ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']

ssh_pwauth: false
disable_root: true

# Minimal setup - let Ansible handle the rest
runcmd:
  # Load essential kernel modules
  - modprobe overlay
  - modprobe br_netfilter
  
  # Disable swap (critical for Kubernetes)
  - swapoff -a
  - sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
  
  # Apply basic sysctl settings
  - sysctl --system

# No reboot - keep it simple
power_state:
  mode: reboot
  timeout: 30
  condition: true

# Final message
final_message: |
  ðŸŽ‰ Minimal cloud-init setup completed!
  
  Node: k8s-node-2 
  User: k8s_81
  
  âœ… Basic system configured
  âœ… SSH access ready
  âœ… Minimal Kubernetes prep done
  
  Ready for Ansible deployment!