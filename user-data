#cloud-config
hostname: k8s-node-1
timezone: America/Los_Angeles
users:
  - name: k8s_80
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDC5PcI8sHqG8w7K9UM68bOIC26Ie/J/xHm5Wr+3lpAGI8K3qzd0rzEUlJ2F34BuULKN+yW+R1ElXvAO/9yJTZjFH8YwVNSh5cYi07/NJ7j4wVQyzdif6z0s4WkLvpHni00OlISc/ul8CIFAhAVeXrXJVYhp85tZEsE7lQpmV2zr4dAaqLUWJap7QM63Mrypr+PasJS1uaB8+4yqOsmVm/xLsgrTZ/+HqPb1BQzAtL054Jp1K1YUsjukFQV7AgSav/3CHEeYxDiKxI0d1lllQDPKWEvLExToqZCDUarATjBw8OX+3NPRoal9O5Weux9Cx/ISIf3OXexMdy2fLhpCjOM6ppyanCecA4kSS+vgIGMXv8euAE+PTlmxPS4vLT2WPjxVR0O/6myDuZrFu3dwmFiyAeGtbN2E4tdiQ5vQXKAg1FYgt1fRMXYtkiFa3/jhROd36Hpem8A9L3t/3y2ZUwqZLPzjgYnVvcgHQNKkqou3cq/m13qtdOj7Fh6TSrbElBjrNvR8iFDquLjaQX5pyQvw93llk0C8CpUGK9TkAgHV42CxkERDQ1D/sDoFgV3zmSTY049JrZAohDBWSqbujNRdWc5R9h9cM9Kvk7xchUdA6FKpr7GnyrIGexEgVHvkveBC71o9xzT6XhEANkDIOWTJyWcrd7Ebiu4fo90tphB4w== k8s_pi key
    groups: [sudo, docker, sys]
    shell: /bin/bash
chpasswd:
  expire: false
ssh_pwauth: false
disable_root: true

# Separate packages into groups for better error handling
package_update: true
package_upgrade: true
packages:
  - docker.io
  - python3-pip
  - python3-venv
  - python3-dev
  - libffi-dev
  - libssl-dev
  - git
  - apt-transport-https
  - ca-certificates
  - curl
  - software-properties-common

write_files:
  - path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    content: |
      network: {config: disabled}
  - path: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
  - path: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
  - path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    encoding: gz+b64
    content: |
      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
      
runcmd:
  # Set up Kubernetes repository
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  - echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
  - apt-get update

  # Install Kubernetes components after repo setup
  - apt-get install -y kubelet kubeadm kubectl
  - apt-mark hold kubelet kubeadm kubectl
  
  # Configure containerd
  - mkdir -p /etc/containerd
  - containerd config default > /etc/containerd/config.toml
  - sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
  - systemctl restart containerd
  
  # Load kernel modules required by Kubernetes
  - modprobe overlay
  - modprobe br_netfilter
  
  # Apply sysctl params
  - sysctl --system
  
  # Disable swap
  - swapoff -a
  - sed -i '/swap/d' /etc/fstab
  
  # Enable and start services
  - systemctl enable kubelet
  - systemctl enable ssh
  - systemctl restart ssh
