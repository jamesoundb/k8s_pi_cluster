---
# kube_proxy role - Kubernetes network proxy configuration

- name: Create kube-proxy directory
  file:
    path: /var/lib/kube-proxy
    state: directory
    mode: '0755'

# Initialize kube-proxy configuration on the first control plane node
- name: Generate kube-proxy configuration
  block:
    - name: Generate kube-proxy kubeconfig
      shell: kubeadm init phase kubeconfig kube-proxy
      args:
        creates: /etc/kubernetes/kube-proxy.conf
      
    - name: Create kube-proxy ConfigMap
      shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f - <<EOF
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: kube-proxy
          namespace: kube-system
        data:
          config.conf: |-
            apiVersion: kubeproxy.config.k8s.io/v1alpha1
            kind: KubeProxyConfiguration
            mode: "ipvs"
            ipvs:
              strictARP: true
            metricsBindAddress: "0.0.0.0:10249"
          kubeconfig.conf: |-
            apiVersion: v1
            kind: Config
            clusters:
            - cluster:
                certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                server: https://{{ hostvars[groups['k8s_master_init'][0]]['ansible_host'] }}:6443
              name: default
            contexts:
            - context:
                cluster: default
                namespace: default
                user: default
              name: default
            current-context: default
            users:
            - name: default
              user:
                tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
        EOF
      args:
        executable: /bin/bash
  when: inventory_hostname == groups['k8s_master_init'][0]

# Deploy DaemonSet for kube-proxy
- name: Deploy kube-proxy DaemonSet
  shell: |
    kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f - <<EOF
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      labels:
        k8s-app: kube-proxy
      name: kube-proxy
      namespace: kube-system
    spec:
      selector:
        matchLabels:
          k8s-app: kube-proxy
      template:
        metadata:
          labels:
            k8s-app: kube-proxy
        spec:
          containers:
          - name: kube-proxy
            image: registry.k8s.io/kube-proxy:v1.29.0
            imagePullPolicy: IfNotPresent
            command:
            - /usr/local/bin/kube-proxy
            - --config=/var/lib/kube-proxy/config.conf
            - --hostname-override=$(NODE_NAME)
            env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            securityContext:
              privileged: true
            volumeMounts:
            - mountPath: /var/lib/kube-proxy
              name: kube-proxy
            - mountPath: /run/xtables.lock
              name: xtables-lock
            - mountPath: /lib/modules
              name: lib-modules
              readOnly: true
          hostNetwork: true
          priorityClassName: system-node-critical
          serviceAccountName: kube-proxy
          tolerations:
          - operator: Exists
          volumes:
          - configMap:
              name: kube-proxy
              defaultMode: 420
            name: kube-proxy
          - hostPath:
              path: /run/xtables.lock
              type: FileOrCreate
            name: xtables-lock
          - hostPath:
              path: /lib/modules
              type: ""
            name: lib-modules
    EOF
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['k8s_master_init'][0]