---
# etcd role - High availability key-value store for Kubernetes
# This is initialized using kubeadm on the first control plane node

- name: Create etcd data directory
  file:
    path: /var/lib/etcd
    state: directory
    mode: '0700'

# On the first control plane node (init node)
- name: Create Kubernetes configuration directory
  file:
    path: /etc/kubernetes/
    state: directory
    mode: '0755'
  when: inventory_hostname in groups['k8s_master_init']

# Generate certificates independently
- name: Generate etcd CA and certificates
  block:
    - name: Create PKI directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0750'
      loop:
        - /etc/kubernetes/pki
        - /etc/kubernetes/pki/etcd

    - name: Generate etcd CA private key
      shell: openssl genrsa -out /etc/kubernetes/pki/etcd/ca.key 2048
      args:
        creates: /etc/kubernetes/pki/etcd/ca.key

    - name: Generate etcd CA certificate
      shell: openssl req -x509 -new -nodes -key /etc/kubernetes/pki/etcd/ca.key -subj "/CN=etcd-ca" -days 10000 -out /etc/kubernetes/pki/etcd/ca.crt
      args:
        creates: /etc/kubernetes/pki/etcd/ca.crt

    - name: Generate etcd server private key
      shell: openssl genrsa -out /etc/kubernetes/pki/etcd/server.key 2048
      args:
        creates: /etc/kubernetes/pki/etcd/server.key

    - name: Create etcd server certificate config
      copy:
        dest: /etc/kubernetes/pki/etcd/server-csr.conf
        content: |
          [req]
          req_extensions = v3_req
          distinguished_name = req_distinguished_name
          [req_distinguished_name]
          [ v3_req ]
          basicConstraints = CA:FALSE
          keyUsage = nonRepudiation, digitalSignature, keyEncipherment
          subjectAltName = @alt_names
          [alt_names]
          DNS.1 = localhost
          DNS.2 = {{ inventory_hostname }}
          IP.1 = 127.0.0.1
          IP.2 = {{ ansible_host }}
        mode: '0644'

    - name: Generate etcd server CSR
      shell: openssl req -new -key /etc/kubernetes/pki/etcd/server.key -subj "/CN={{ inventory_hostname }}" -config /etc/kubernetes/pki/etcd/server-csr.conf -out /etc/kubernetes/pki/etcd/server.csr
      args:
        creates: /etc/kubernetes/pki/etcd/server.csr

    - name: Sign etcd server certificate
      shell: openssl x509 -req -in /etc/kubernetes/pki/etcd/server.csr -CA /etc/kubernetes/pki/etcd/ca.crt -CAkey /etc/kubernetes/pki/etcd/ca.key -CAcreateserial -out /etc/kubernetes/pki/etcd/server.crt -days 10000 -extensions v3_req -extfile /etc/kubernetes/pki/etcd/server-csr.conf
      args:
        creates: /etc/kubernetes/pki/etcd/server.crt
  when: inventory_hostname in groups['k8s_master_init']

# Distribute certificates to other control plane nodes
- name: Ensure PKI directory exists on other nodes
  file:
    path: /etc/kubernetes/pki/etcd
    state: directory
    mode: '0750'
    owner: root
    group: root
  when: inventory_hostname in groups['k8s_master'] and inventory_hostname not in groups['k8s_master_init']

- name: Fetch certificates from primary node
  fetch:
    src: "/etc/kubernetes/pki/etcd/{{ item }}"
    dest: "/tmp/etcd-certs/"
    flat: yes
  with_items:
    - ca.crt
    - ca.key
    - server.crt
    - server.key
  when: inventory_hostname == groups['k8s_master_init'][0]

- name: Copy certificates to secondary nodes
  copy:
    src: "/tmp/etcd-certs/{{ item }}"
    dest: "/etc/kubernetes/pki/etcd/{{ item }}"
    mode: '0600'
    owner: root
    group: root
  with_items:
    - ca.crt
    - ca.key
    - server.crt
    - server.key
  when: inventory_hostname in groups['k8s_master'] and inventory_hostname not in groups['k8s_master_init']

# Replace the cleanup task with a remote cleanup
- name: Cleanup temporary certificate directory on remote nodes
  file:
    path: "/tmp/etcd-certs-{{ inventory_hostname }}"
    state: absent
  when: inventory_hostname in groups['k8s_master']

# For all etcd nodes (all control-plane nodes)
- name: Apply etcd performance optimizations
  copy:
    dest: /etc/systemd/system/etcd.service.d/10-performance.conf
    content: |
      [Service]
      Environment="ETCD_SNAPSHOT_COUNT=5000"
      Environment="ETCD_HEARTBEAT_INTERVAL=100"
      Environment="ETCD_ELECTION_TIMEOUT=1000"
    mode: '0644'
  notify: Reload systemd

# Set up automatic etcd backups
- name: Set up automatic etcd backups
  cron:
    name: "backup etcd"
    minute: "0"
    hour: "*/6"
    job: "mkdir -p /home/{{ ansible_user }}/etcd-backups && ETCDCTL_API=3 etcdctl --endpoints=localhost:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot save /home/{{ ansible_user }}/etcd-backups/etcd-snapshot-$(date +%Y%m%d-%H%M).db && find /home/{{ ansible_user }}/etcd-backups -type f -mtime +7 -delete"
  when: inventory_hostname in groups['k8s_master']