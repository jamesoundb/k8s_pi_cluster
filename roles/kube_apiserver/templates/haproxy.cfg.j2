global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Stats page (optional)
listen stats
    bind *:9000
    mode http
    stats enable
    stats uri /stats
    stats realm HAProxy\ Statistics
    stats auth admin:{{ haproxy_stats_password | default('adminpassword') }}

# Kubernetes API Server frontend
frontend k8s-api
    bind 0.0.0.0:{{ control_plane_endpoint_port | default('6443') }}
    bind {{ control_plane_endpoint }}:{{ control_plane_endpoint_port | default('6443') }}
    mode tcp
    option tcplog
    timeout client 300000
    default_backend k8s-api-backend

# Kubernetes API Server backend
backend k8s-api-backend
    mode tcp
    option tcp-check
    balance roundrobin
    timeout server 300000
    timeout connect 5000
    {% for host in groups['k8s_master'] %}
    server apiserver{{ loop.index }} {{ hostvars[host]['ansible_host'] }}:6444 check fall 3 rise 2
    {% endfor %}
    # Dynamically generated for all control plane nodes
