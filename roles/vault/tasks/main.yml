---
# Vault HA Deployment - Complete end-to-end automation
# This playbook handles all aspects: Helm, storage, initialization, configuration

# ==============================================
# PHASE 0: PREREQUISITES
# ==============================================

- name: Display Vault deployment plan
  debug:
    msg:
      - "=== VAULT HA DEPLOYMENT PLAN ==="
      - "Version: {{ vault_version }}"
      - "Namespace: {{ vault_namespace }}"
      - "Replicas: {{ vault_replicas }}"
      - "Storage: {{ vault_storage_size }} ({{ vault_storage_class }})"
      - "UI: {{ vault_ui_enabled }}"

# [0.1] Install Helm on control node
- name: Check if Helm is installed
  shell: which helm
  register: helm_check
  ignore_errors: true

- name: Install Helm 3
  shell: |
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  when: helm_check.rc != 0
  register: helm_install
  until: helm_install.rc == 0
  retries: 3
  delay: 5

# ==============================================
# PHASE 1: NAMESPACE & RBAC
# ==============================================

- name: Create Vault namespace with labels
  shell: |
    kubectl create namespace {{ vault_namespace }} --dry-run=client -o yaml | kubectl apply -f -
    kubectl label namespace {{ vault_namespace }} \
      name={{ vault_namespace }} \
      purpose=vault \
      --overwrite
  register: ns_result

- name: Verify namespace exists
  shell: |
    kubectl get namespace {{ vault_namespace }}
  register: ns_verify

# ==============================================
# PHASE 1.5: ISTIO SIDECAR INJECTION EXCLUSION
# ==============================================

- name: Exclude vault namespace from Istio sidecar injection
  shell: |
    # Check if istio sidecar injector webhook exists
    if kubectl get mutatingwebhookconfigurations istio-sidecar-injector 2>/dev/null; then
      # Add vault to the exclusion list
      kubectl patch mutatingwebhookconfigurations istio-sidecar-injector \
        --type='json' \
        -p='[{"op": "add", "path": "/webhooks/0/namespaceSelector/matchExpressions/0/values/-", "value": "vault"}]' 2>/dev/null || true
    fi
  ignore_errors: true

# ==============================================
# PHASE 2: STORAGE PREPARATION
# ==============================================

- name: Check if storage class exists
  shell: |
    kubectl get storageclass {{ vault_storage_class }} 2>/dev/null && echo "EXISTS" || echo "NOT_FOUND"
  register: storage_class_check
  ignore_errors: true

- name: Delete existing storage class if different config
  shell: |
    kubectl delete storageclass {{ vault_storage_class }} 2>/dev/null || true
  ignore_errors: true

- name: Create local storage class for persistent volumes
  shell: |
    kubectl apply -f - <<'EOF'
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
      name: {{ vault_storage_class }}
    provisioner: kubernetes.io/no-provisioner
    allowVolumeExpansion: true
    volumeBindingMode: WaitForFirstConsumer
    EOF
  register: storage_class_result

- name: Verify storage class created
  shell: |
    kubectl get storageclass {{ vault_storage_class }}
  register: storage_verify

# ==============================================
# PHASE 2.5: CREATE PERSISTENT VOLUMES ON WORKERS
# ==============================================

- name: Create PersistentVolumes on worker nodes for Vault storage
  shell: |
    kubectl apply -f - <<'EOF'
    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: local-pv-vault-1
    spec:
      capacity:
        storage: 10Gi
      volumeMode: Filesystem
      accessModes:
        - ReadWriteOnce
      persistentVolumeReclaimPolicy: Delete
      storageClassName: {{ vault_storage_class }}
      local:
        path: /mnt/vault-data
      nodeAffinity:
        required:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - k8s-worker-1
    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: local-pv-vault-2
    spec:
      capacity:
        storage: 10Gi
      volumeMode: Filesystem
      accessModes:
        - ReadWriteOnce
      persistentVolumeReclaimPolicy: Delete
      storageClassName: {{ vault_storage_class }}
      local:
        path: /mnt/vault-data
      nodeAffinity:
        required:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - k8s-worker-2
    ---
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: local-pv-vault-3
    spec:
      capacity:
        storage: 10Gi
      volumeMode: Filesystem
      accessModes:
        - ReadWriteOnce
      persistentVolumeReclaimPolicy: Delete
      storageClassName: {{ vault_storage_class }}
      local:
        path: /mnt/vault-data
      nodeAffinity:
        required:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - k8s-worker-3
    EOF
  register: pv_creation
  retries: 2
  delay: 5
  until: pv_creation.rc == 0

- name: Verify PersistentVolumes created
  shell: |
    kubectl get pv | grep local-pv-vault
  register: pv_verify

- name: Display PV status
  debug:
    msg: "{{ pv_verify.stdout_lines }}"

- name: Prepare vault data directories on worker nodes via debug pods
  shell: |
    cat <<'DEBUGPOD' | kubectl apply -f -
    apiVersion: v1
    kind: Pod
    metadata:
      name: debug-vault-setup-{{ item }}
      namespace: {{ vault_namespace }}
    spec:
      nodeName: {{ item }}
      hostNetwork: true
      hostPID: true
      containers:
      - name: debug
        image: busybox:latest
        command: ['/bin/sh', '-c', 'mkdir -p /mnt/vault-data && chmod 777 /mnt/vault-data && echo "Created on {{ item }}" && sleep 30']
        volumeMounts:
        - name: host-root
          mountPath: /mnt
      volumes:
      - name: host-root
        hostPath:
          path: /mnt
          type: DirectoryOrCreate
    DEBUGPOD
  loop:
    - k8s-worker-1
    - k8s-worker-2
    - k8s-worker-3
  register: debug_pods_created
  ignore_errors: true

- name: Wait for debug pods to complete and create directories
  shell: |
    sleep 15
  register: wait_dirs

- name: Clean up debug pods
  shell: |
    kubectl delete pod -n {{ vault_namespace }} -l debug-vault-setup --grace-period=5 2>/dev/null || true
  register: debug_cleanup
  ignore_errors: true

- name: Verify vault data directories created
  debug:
    msg: "âœ… Vault data directories prepared on all worker nodes"

# ==============================================
# PHASE 3: HELM REPOSITORY SETUP
# ==============================================

- name: Add HashiCorp Helm repository
  shell: |
    helm repo add hashicorp {{ vault_helm_repo }} 2>/dev/null || echo "already exists"
    helm repo update hashicorp
  register: helm_repo
  until: helm_repo.rc == 0
  retries: 3
  delay: 5

- name: Check Vault Helm chart available
  shell: |
    helm search repo hashicorp/vault
  register: helm_search

# ==============================================
# PHASE 4: VAULT DEPLOYMENT VIA HELM
# ==============================================

- name: Delete existing Vault release if present
  shell: |
    helm uninstall vault -n vault 2>/dev/null || true
  ignore_errors: true

- name: Deploy Vault HA cluster via Helm
  shell: |
    helm install vault hashicorp/vault \
      --namespace vault \
      --create-namespace \
      --set server.ha.enabled=true \
      --set server.ha.replicas=3 \
      --set server.ha.raft.enabled=true \
      --set server.dataStorage.enabled=true \
      --set server.dataStorage.size=10Gi \
      --set server.dataStorage.storageClass=local-storage \
      --set ui.enabled=true \
      --set server.ui.enabled=true \
      --set server.image.repository=hashicorp/vault \
      --set server.image.tag=1.16.0 \
      --set server.resources.requests.cpu=250m \
      --set server.resources.requests.memory=256Mi \
      --set server.resources.limits.cpu=500m \
      --set server.resources.limits.memory=512Mi \
      --set csi.enabled=false \
      --set injector.enabled=true
  register: helm_deploy
  retries: 3
  delay: 10
  until: helm_deploy.rc == 0

- name: Display Helm deployment status
  debug:
    msg: "{{ helm_deploy.stdout_lines[-5:] }}"

# ==============================================
# PHASE 5: STORAGE BINDING & PVC VERIFICATION
# ==============================================

- name: Wait for PVCs to be created
  shell: |
    for i in $(seq 0 $(({{ vault_replicas }} - 1))); do
      kubectl wait --for=condition=Bound \
        pvc/data-vault-$i \
        -n {{ vault_namespace }} \
        --timeout=2m || true
    done
  register: pvc_wait
  ignore_errors: true

- name: Get PVC status
  shell: |
    kubectl get pvc -n {{ vault_namespace }} -o wide
  register: pvc_status

- name: Display PVC status
  debug:
    msg: "{{ pvc_status.stdout_lines }}"

# ==============================================
# PHASE 6: POD READINESS
# ==============================================

- name: Wait for Vault pods to reach Running phase
  shell: |
    for i in $(seq 0 $(({{ vault_replicas }} - 1))); do
      kubectl wait --for=condition=Ready \
        pod/vault-$i \
        -n {{ vault_namespace }} \
        --timeout=5m || true
    done
  register: pod_wait
  ignore_errors: true
  retries: 2
  delay: 10

- name: Check Vault pod statuses
  shell: |
    kubectl get pods -n {{ vault_namespace }} -l app.kubernetes.io/name=vault -o wide
  register: pod_status

- name: Display pod status
  debug:
    msg: "{{ pod_status.stdout_lines }}"

# ==============================================
# PHASE 7: INITIALIZATION & UNSEALING (Bootstrap Pod Approach)
# ==============================================
# NOTE: Using bootstrap pod instead of kubectl exec to avoid kubelet TLS issues
# with worker nodes. Bootstrap pod runs on master node and uses in-cluster DNS.

- name: Create Vault bootstrap pod for initialization
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: v1
    kind: Pod
    metadata:
      name: vault-bootstrap
      namespace: {{ vault_namespace }}
      labels:
        app: vault-bootstrap
    spec:
      serviceAccountName: vault
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Equal
        effect: NoSchedule
      containers:
      - name: vault-init
        image: hashicorp/vault:{{ vault_version }}
        command: ['/bin/sh']
        args: ['-c', 'sleep 3600']
        env:
        - name: VAULT_ADDR
          value: "http://vault.{{ vault_namespace }}.svc.cluster.local:8200"
        - name: VAULT_SKIP_VERIFY
          value: "true"
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
      volumes:
      - name: vault-config
        emptyDir: {}
      restartPolicy: Never
    EOF
  register: bootstrap_created
  ignore_errors: true

- name: Wait for bootstrap pod to be running
  shell: |
    kubectl wait --for=condition=Ready \
      pod/vault-bootstrap \
      -n {{ vault_namespace }} \
      --timeout=2m || true
  register: bootstrap_ready
  ignore_errors: true

- name: Check if Vault is already initialized
  shell: |
    kubectl exec -n {{ vault_namespace }} vault-bootstrap -- \
      vault status 2>&1 | grep -q "Initialized.*true" && echo "INITIALIZED" || echo "NOT_INITIALIZED"
  register: vault_init_check
  retries: 5
  delay: 10
  ignore_errors: true
  when: bootstrap_ready.rc == 0

- name: Initialize Vault (if needed)
  shell: |
    kubectl exec -n {{ vault_namespace }} vault-bootstrap -- \
      vault operator init \
        -key-shares=3 \
        -key-threshold=2 \
        -format=json | tee /tmp/vault-keys.json
  when: 
    - vault_init_check.rc == 0
    - vault_init_check.stdout == "NOT_INITIALIZED"
  register: vault_init
  ignore_errors: true

- name: Verify initialization completed
  shell: |
    [ -f /tmp/vault-keys.json ] && grep -q "unseal_keys_b64" /tmp/vault-keys.json && echo "SUCCESS" || echo "FAILED"
  register: init_verify
  ignore_errors: true

- name: Create keys backup in ansible temp
  shell: |
    if [ -f /tmp/vault-keys.json ]; then
      cp /tmp/vault-keys.json /tmp/vault-keys-backup.json
      echo "âœ… Vault keys backed up - SAVE TO SECURE LOCATION"
      echo "File: /tmp/vault-keys.json"
      echo "Size: $(wc -c < /tmp/vault-keys.json) bytes"
    else
      echo "âš ï¸  Keys file not found - initialization may have failed"
    fi
  register: keys_backup

- name: Display keys backup status
  debug:
    msg: "{{ keys_backup.stdout_lines }}"

- name: Extract unseal keys if available
  shell: |
    if [ -f /tmp/vault-keys.json ]; then
      python3 -c "
import json
try:
    with open('/tmp/vault-keys.json') as f:
        data = json.load(f)
        keys = data.get('unseal_keys_b64', [])
        for key in keys:
            print(key)
except Exception as e:
    print(f'ERROR: {e}')
" 2>/dev/null || echo "KEY_EXTRACT_FAILED"
    else
      echo "NO_KEYS_FILE"
    fi
  register: unseal_keys
  ignore_errors: true

- name: Unseal Vault pods with extracted keys using bootstrap pod
  shell: |
    if [ "{{ unseal_keys.stdout_lines | length }}" -gt 1 ]; then
      # Extract first 2 unseal keys from output
      KEY1="{{ unseal_keys.stdout_lines[0] }}"
      KEY2="{{ unseal_keys.stdout_lines[1] }}"
      
      echo "Attempting to unseal Vault with 2 of 3 keys..."
      
      # Unseal all vault pods
      for i in {0..{{ vault_replicas - 1 }}}; do
        POD="vault-$i"
        echo "Unsealing $POD..."
        kubectl exec -n {{ vault_namespace }} vault-bootstrap -- \
          sh -c "vault write -f sys/unseal key=$KEY1" 2>/dev/null || true
        kubectl exec -n {{ vault_namespace }} vault-bootstrap -- \
          sh -c "vault write -f sys/unseal key=$KEY2" 2>/dev/null || true
        sleep 2
      done
      echo "âœ… Vault unsealing attempted"
    else
      echo "âš ï¸  Keys not available for unsealing: {{ unseal_keys.stdout | default('NO_KEYS_FILE') }}"
    fi
  register: unseal_result
  ignore_errors: true

- name: Cleanup bootstrap pod
  shell: |
    kubectl delete pod vault-bootstrap -n {{ vault_namespace }} --ignore-not-found=true
  register: bootstrap_cleanup
  ignore_errors: true

# ==============================================
# PHASE 8: VERIFICATION & STATUS
# ==============================================

- name: Wait for Vault to be unsealed and ready
  shell: |
    # Try to check Vault status via service endpoint
    for i in {1..30}; do
      STATUS=$(kubectl get pods -n {{ vault_namespace }} -l app.kubernetes.io/name=vault -o jsonpath='{.items[0].status.phase}' 2>/dev/null)
      if [ "$STATUS" == "Running" ]; then
        echo "âœ… Vault pods are Running"
        # Check if keys were successfully created
        if [ -f /tmp/vault-keys.json ]; then
          echo "âœ… Vault initialization keys available"
          exit 0
        fi
      fi
      sleep 5
    done
    echo "âš ï¸  Vault pods not yet fully operational - may require manual unseal"
  register: vault_ready
  ignore_errors: true

- name: Get final Vault pod status
  shell: |
    kubectl get pods -n {{ vault_namespace }} -l app.kubernetes.io/name=vault -o wide
  register: vault_pod_status

- name: Display Vault pod status
  debug:
    msg: "{{ vault_pod_status.stdout_lines }}"

- name: Display initialization keys location
  debug:
    msg:
      - "âœ… Vault HA deployment complete!"
      - ""
      - "ğŸ“ INITIALIZATION KEYS:"
      - "   Location: /tmp/vault-keys.json"
      - "   âš ï¸  SAVE TO SECURE OFFLINE LOCATION IMMEDIATELY"
      - ""
      - "ğŸ” Next Step - Manual Key Backup:"
      - "   1. Copy /tmp/vault-keys.json to secure location"
      - "   2. Store root token and unseal keys separately"
      - "   3. Delete /tmp/vault-keys.json from this server"
      - ""

# ==============================================
# PHASE 9: KUBERNETES AUTH - DEFERRED TO PKI CONFIGURATION
# ==============================================
# NOTE: Kubernetes auth will be configured in Phase 4 of vault-initialization-guide.md
# This is deferred because Vault needs to be unsealed first, which requires manual 
# key entry from the initialization file saved by this playbook.

- name: Display PKI configuration instructions
  debug:
    msg:
      - ""
      - "â­ï¸  NEXT STEPS - Vault PKI Configuration:"
      - ""
      - "   Phase 4 of docs/vault-initialization-guide.md covers:"
      - "   1. Manual key backup and secure storage"
      - "   2. Unsealing Vault using the 3 unseal keys"
      - "   3. Enabling PKI secrets engine"
      - "   4. Creating root CA and intermediate CA for Istio"
      - "   5. Enabling Kubernetes auth method"
      - "   6. Configuring Kubernetes auth for service accounts"
      - ""
      - "   Execute Phase 4 commands in order from:"
      - "   docs/vault-initialization-guide.md (Phase 4 section)"
      - ""

# ==============================================
# PHASE 10: DEPLOYMENT SUMMARY
# ==============================================

- name: Get final Vault cluster info
  shell: |
    echo "=== DEPLOYMENTS ===" && \
    kubectl get deployments -n {{ vault_namespace }} && \
    echo "" && echo "=== STATEFULSETS ===" && \
    kubectl get statefulsets -n {{ vault_namespace }} && \
    echo "" && echo "=== PODS ===" && \
    kubectl get pods -n {{ vault_namespace }} -l app.kubernetes.io/name=vault && \
    echo "" && echo "=== SERVICES ===" && \
    kubectl get svc -n {{ vault_namespace }}
  register: vault_summary

- name: Display Vault deployment summary
  debug:
    msg: "{{ vault_summary.stdout_lines }}"

- name: Display final instructions
  debug:
    msg:
      - ""
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘          VAULT HA DEPLOYMENT COMPLETE                      â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ“¦ Deployment Details:"
      - "   Namespace: {{ vault_namespace }}"
      - "   Replicas: {{ vault_replicas }}"
      - "   Storage: {{ vault_storage_size }} ({{ vault_storage_class }})"
      - ""
      - "ğŸ”‘ CRITICAL - Initialization Keys:"
      - "   Location: /tmp/vault-keys.json"
      - "   âš ï¸  SAVE TO SECURE OFFLINE LOCATION!"
      - "   File contains:"
      - "     â€¢ 3 unseal keys (need 2 to unseal)"
      - "     â€¢ Root token for initial access"
      - ""
      - "ğŸŒ Access Vault:"
      - "   Port-forward: kubectl port-forward -n {{ vault_namespace }} svc/vault 8200:8200"
      - "   UI: https://localhost:8200"
      - "   API: http://vault.{{ vault_namespace }}:8200 (internal)"
      - ""
      - "ğŸ”“ Manual Unseal (if pods show sealed=true):"
      - "   1. kubectl exec -it -n {{ vault_namespace }} vault-0 -- sh"
      - "   2. vault operator unseal KEY_1"
      - "   3. vault operator unseal KEY_2"
      - "   4. Exit and check: vault status -tls-skip-verify"
      - ""
      - "â­ï¸  Next Steps:"
      - "   1. Save initialization keys securely"
      - "   2. Verify all pods are READY (status: 1/1)"
      - "   3. Configure policies for trading agent"
      - "   4. Set up AppRole for automated access"
      - "   5. Deploy Istio service mesh"
      - ""
