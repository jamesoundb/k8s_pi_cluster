---
# Common role - OS preparation tasks for Kubernetes

# Check node health and connectivity first
- name: Check node health and connectivity
  include_tasks: node_health_check.yml

- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: Configure hosts file
  lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item]['ansible_host'] }} {{ item }}"
    state: present
  loop: "{{ groups['k8s_nodes'] }}"

- name: Wait for apt locks to be released
  shell: |
    while lsof /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || lsof /var/lib/apt/lists/lock >/dev/null 2>&1 || lsof /var/cache/apt/archives/lock >/dev/null 2>&1 || lsof /var/lib/dpkg/lock >/dev/null 2>&1; do
      echo "Waiting for apt lock to be released..."
      sleep 5
    done
  changed_when: false

- name: Fix all corrupted dpkg files
  shell: |
    rm -rf /var/lib/dpkg/updates/*
    touch /var/lib/dpkg/status
  changed_when: true

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required packages
  apt:
    name: "{{ common_packages }}"
    state: present

- name: Disable swap
  shell: |
    swapoff -a
    sed -i '/swap/d' /etc/fstab
  changed_when: true

- name: Enable required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  with_items: "{{ kernel_modules }}"

- name: Setup required kernel modules to load at boot
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      {% for module in kernel_modules %}
      {{ module }}
      {% endfor %}
    mode: '0644'

- name: Configure sysctl params for Kubernetes
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
    mode: '0644'

- name: Apply sysctl parameters
  command: sysctl --system
  changed_when: true

- name: Optimize kernel parameters for container workloads
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-kubernetes-performance.conf
  with_items: "{{ sysctl_settings }}"

# Raspberry Pi specific optimization
- name: Create GPU memory split configuration for Pi
  lineinfile:
    path: /boot/firmware/config.txt
    line: "{{ item }}"
    create: yes
  with_items:
    - "# Limit GPU memory to provide more RAM to the system"
    - "gpu_mem={{ raspberry_pi_gpu_mem }}"
  when: "'arm' in ansible_architecture"